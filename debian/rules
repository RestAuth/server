#!/usr/bin/make -f

PY2VERS=$(shell pyversions -rv)

PY2DIR=${CURDIR}/debian/restauth/
DOCDIR=${CURDIR}/debian/restauth-doc/

DH_ARGS=--with python2


%:
	dh $@ ${DH_ARGS}

build-python%:
	dh_testdir
	python$* setup.py build

override_dh_auto_build: ${PY2VERS:%=build-python%}
	# build documentation
	python setup.py build_doc -t debian

	# Disable python3 for now, depends on Django1.5
	#set -ex; for python in $(shell py3versions -r); do \
	#	$$python setup.py build; \
	#done;

	dh_auto_build

install-python2%:
	dh_testdir
	python2$* setup.py install --force --root ${PY2DIR} --no-compile -O0 --install-layout=deb

override_dh_auto_install: ${PY2VERS:%=install-python%}
	dh_auto_install
	
	# rename language scripts:
	rm -f ${PY2DIR}usr/bin/restauth-manage.py
	rename s/.py// ${PY2DIR}usr/bin/*
	
override_dh_python2:
	dh_python2
	mv ${PY2DIR}usr/share/pyshared/RestAuth/localsettings.py ${PY2DIR}etc/restauth/settings.py

test-python%:
	python$* setup.py test

ifeq (,$(findstring nocheck,$(DEB_BUILD_OPTIONS)))
override_dh_auto_test: ${PY2VERS:%=test-python%}
endif

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog
